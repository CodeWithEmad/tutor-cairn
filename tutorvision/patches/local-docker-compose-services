####### vision plugin

# log collection
vision-vector:
    image: docker.io/timberio/vector:0.13.X-alpine
    volumes:
        - ../plugins/vision/apps/vector/vector.toml:/etc/vector/vector.toml:ro
        {% if VISION_DOCKER_HOST %}- {{ VISION_DOCKER_HOST }}:/var/run/docker.sock:ro{% endif %}
    environment:
        - DOCKER_HOST=/var/run/docker.sock
    restart: unless-stopped

{% if VISION_RUN_CLICKHOUSE %}
# log storage
vision-clickhouse:
    image: {{ VISION_CLICKHOUSE_DOCKER_IMAGE }}
    volumes:
        - ../../data/vision/clickhouse:/var/lib/clickhouse
        - ../plugins/vision/apps/clickhouse/users.d/vision.xml:/etc/clickhouse-server/users.d/vision.xml:ro
    ulimits:
        nofile:
            soft: 262144
            hard: 262144
    restart: unless-stopped
{% endif %}

# redash config docs:
# https://github.com/getredash/setup/blob/master/data/docker-compose.yml
# https://github.com/getredash/redash/blob/master/CHANGELOG.md

# frontend
vision-redash:
    image: {{ VISION_REDASH_DOCKER_IMAGE }}
    command: gunicorn -b 0.0.0.0:5000 --name redash --workers=2 --max-requests=1000 --max-requests-jitter=100 --timeout=120 redash.wsgi:app
    env_file: ../plugins/vision/apps/redash/env
    environment:
        REDASH_WEB_WORKERS: 4
    volumes:
        - ../plugins/vision/apps/redash/scripts/:/redash/scripts/:ro
    restart: unless-stopped
    depends_on:
        - vision-postgresql
        - vision-redis
vision-redash-scheduler:
    image: {{ VISION_REDASH_DOCKER_IMAGE }}
    command: scheduler
    env_file: ../plugins/vision/apps/redash/env
    restart: unless-stopped
    depends_on:
        - vision-postgresql
        - vision-redis
vision-redash-worker-scheduled:
    image: {{ VISION_REDASH_DOCKER_IMAGE }}
    command: worker
    env_file: ../plugins/vision/apps/redash/env
    environment:
        QUEUES: "scheduled_queries schemas"
        WORKERS_COUNT: 1
    restart: unless-stopped
    depends_on:
        - vision-postgresql
        - vision-redis
vision-redash-worker-queries:
    image: {{ VISION_REDASH_DOCKER_IMAGE }}
    command: worker
    env_file: ../plugins/vision/apps/redash/env
    environment:
        QUEUES: "queries"
        WORKERS_COUNT: 2
    restart: unless-stopped
    depends_on:
        - vision-postgresql
        - vision-redis
vision-redash-worker-default:
    image: {{ VISION_REDASH_DOCKER_IMAGE }}
    command: worker
    env_file: ../plugins/vision/apps/redash/env
    environment:
        QUEUES: "periodic emails default"
        WORKERS_COUNT: 1
    restart: unless-stopped
    depends_on:
        - vision-postgresql
        - vision-redis
vision-redis:
    image: docker.io/redis:5.0-alpine
    restart: unless-stopped
vision-postgresql:
    image: docker.io/postgres:9.6-alpine
    environment:
        POSTGRES_USER: "{{ VISION_POSTGRESQL_USER }}"
        POSTGRES_PASSWORD: "{{ VISION_POSTGRESQL_PASSWORD }}"
        POSTGRES_DB: "{{ VISION_POSTGRESQL_DB }}"
    volumes:
        - ../../data/vision/postgresql:/var/lib/postgresql/data
    restart: unless-stopped
