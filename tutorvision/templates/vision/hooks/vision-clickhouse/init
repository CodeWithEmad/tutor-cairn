clickhouse_client_base() {
    clickhouse client --host {{ VISION_CLICKHOUSE_HOST }} --port {{ VISION_CLICKHOUSE_PORT }} \
        --user {{ VISION_CLICKHOUSE_USERNAME }} \
        --password {{ VISION_CLICKHOUSE_PASSWORD }} "$@"
}
clickhouse_client() {
    clickhouse_client_base --database={{ VISION_CLICKHOUSE_DATABASE }} "$@"
}
clickhouse_client_query() {
        clickhouse_client --query "$1"
}
clickhouse_client_file() {
    clickhouse_client --multiquery --multiline < "$1"
}
run_migration() {
    migration_name=$(basename "$1")
    echo -n "Applying migration $migration_name... "
    is_applied=$(clickhouse_client_query "SELECT 'applied' FROM migrations WHERE name='$migration_name'")
    if [ "$is_applied" = "applied" ]
    then
        echo "SKIP"
        return
    fi
    clickhouse_client_file "$1"
    clickhouse_client_query "INSERT INTO migrations (name) VALUES ('$migration_name')"
    echo "OK"
}
run_migrations() {
    for migration in /etc/clickhouse-server/migrations.d/*.sql
    do
        run_migration $migration
    done
}
init_db() {
    # Create database
    clickhouse_client_base --query "CREATE DATABASE IF NOT EXISTS {{ VISION_CLICKHOUSE_DATABASE }}"
    # Create migrations table
    clickhouse_client_query "CREATE TABLE IF NOT EXISTS migrations (name String) ENGINE = MergeTree PRIMARY KEY(name) ORDER BY name"
}

init_db
run_migrations
